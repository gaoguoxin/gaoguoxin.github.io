<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[ruby and rails study]]></title>
  <link href="http://gaoguoxin.github.io/atom.xml" rel="self"/>
  <link href="http://gaoguoxin.github.io/"/>
  <updated>2014-02-27T08:13:55+00:00</updated>
  <id>http://gaoguoxin.github.io/</id>
  <author>
    <name><![CDATA[naitnix]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rack]]></title>
    <link href="http://gaoguoxin.github.io/blog/2014/02/27/rack/"/>
    <updated>2014-02-27T02:25:06+00:00</updated>
    <id>http://gaoguoxin.github.io/blog/2014/02/27/rack</id>
    <content type="html"><![CDATA[<h2>Rack是什么</h2>

<blockquote><p>Dabbling in my own web framework experiments, I noticed that there is a lot of code duplication among frameworks since they essentially all do the same things. And still, every Ruby web framework developer is writing his own handlers for every webserver he wants to use. Hopefully, the framework users are satisfied with that choice.</p></blockquote>

<p>以上是rack作者Christian Neukirchen的一句话，意思是说，他在自己开发自己的ruby web framework的时候意识到了这个问题，即很多的ruby web 框架开发者在开发自己的框架的时候都在做很多重复性的工作，写很多的代码来实现一个处理器，以达到这些处理器能适应他们想要用到的每一个webserver，实际上他们写的这些处理器(handler)其实都是在做一件事就是处理http，即接受一个request并且返回一个response。</p>

<!--more-->


<p>rack的灵感来源于phyton社区的wsgi，目标是实现一个最小化的接口来链接web framework  和 web server。rack为用ruby开发的web框架提供了一个最小化的，模块化的，并且适应性强的的接口，它用最简单的方式包装了http request 和http response，它结合并提取了web server 和 ruby web framework 之间的api 到一个call 方法里。</p>

<h2>Rack的最简单实现</h2>

<p>从上面的定义可以看出，rack是将http request 和httpresponse  提取到了一个call方法里面。这个call方法必须接受一个environment参数，这个参数格式应该是一个hash，并返回一个包含了status, headers  和 body 三部分的 一个数组，这个status 代表响应的状态，比如 200，404 500 等，headers是一个集合，包含比如说Content-Type在内的一些信息，body应该十一个字符串类型的数组。例如:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">HelloWorld</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">},</span> <span class="o">[</span><span class="s2">&quot;Hello world!&quot;</span><span class="o">]]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到 Rack 是一个应用(application),这个application 是一个object而不是一个class，这个application (object)可以响应call方法，这个call方法接受一个environment方法，并且返回一个包含status，headers和baody三个元素的数组。以上这个rack application  是我们自己手写的，我们没有依赖任何的gem，就是说，我们只要遵循rack的规范，我们就可以写出自己的rack 应用。</p>

<p>此外，我们还有rack 这个gem，rack  gem 是一个很多高级的和共用的类的集合,能够为我们开发rack应用提供很多的便利，它包含了基本的request，response，cookie，session 的实现，还有很多有用的middleware</p>

<h2>总结</h2>

<ul>
<li>Rack是一个能够运行你自己的ruby框架的框架</li>
<li>Rack提供了一个接口，让你的ruby web framework 能够链接到各种不同的支持rack的 web server ，这些server 包括 passenger、Litespeed, Mongrel, Thin, Ebb, Webrick等。</li>
<li>Rack gem 为你免费提供了 request，response，cookies，params,session等</li>
<li>Rack允许你在一个application中使用多个不同的框架， <a href="http://m.onkey.org/2008/11/10/rails-meets-sinatra">Rails and sinatra integration</a>是一个很好的例子。</li>
<li>Rack提供了中间件(middleware),这个中间件就类似与rails的 前置/后置 过滤器，而且这个中间件可以在不同的rack application中重复使用</li>
</ul>


<h2>Other example</h2>

<figure class='code'><figcaption><span>another rack application</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rack&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">HelloWorld</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="s2">&quot;Hello Rack!&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Mongrel</span><span class="o">.</span><span class="n">run</span> <span class="no">HelloWorld</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">9292</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的代码传递了一个 HelloWord类的实例 到 mongorel  Rack handler ，并且启动端口9292作为服务端口，这个HelloWorld的实例遵循了rack 的基本原则:
*  能够相应call方法，并且这个call方法接受一个environment作为参数
*  这个call方法返回了[http_status_code, response_headers_hash, body]格式的数组</p>

<p>如果我们将上面代码最后一行简单的改写成这样:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">WEBrick</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="no">HelloRack</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">9292</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>向上面这样，我们就可以简单的将webserver 从mongrel 转换到了webrick。如果你这个时候打开浏览器，并访问localhost:9292,你就可以看到页面上输出 Hello Rack!的字样。</p>

<p>我们知道，一个object必须要有call方法才有可能成为rack application，那么在ruby里面，一个proc 对象就有一个call方法，那么是不是可以使用proc对象来构造我们的rack application 呢?看一下下面这个实现:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rack&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Mongrel</span><span class="o">.</span><span class="n">run</span> <span class="nb">proc</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="s2">&quot;Hello Rack!&quot;</span><span class="o">]</span><span class="p">},</span> <span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">9292</span>
</span></code></pre></td></tr></table></div></figure>


<p>看，向上面这个例子，我们使用了proc对象来创建我们的rack application 应用，如果我们访问我们的浏览器地址 localhost:9292,我们一样可以看到正常的输出。</p>

<p>另外一个常用的模式还有:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rack&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>  <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="s2">&quot;Hello Rack!&quot;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Mongrel</span><span class="o">.</span><span class="n">run</span> <span class="nb">method</span><span class="p">(</span><span class="ss">:application</span><span class="p">),</span> <span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">9292</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种模式中，method方法的接收者是main，method方法会查找这个main对象的application方法，并执行这个方法。</p>

<h2>Rackup</h2>

<p>rack 这个gem 为我们提供了很多有用的工具，能够让我们在开发rack应用的时候更轻松，rackup就是其中之一。在上面的例子中，我们直接使用了mongrel handler Rack::Handler::Mongrel  和 webrick handler Rack::Handler::Mongrel 而且是直接将端口号写了进去，如果我们使用rackup的话，这些事情将会变得非常简单和自然，但是我们必须提供一个叫做config.ru的文件。对于上面的例子，我们可以这样：</p>

<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">run</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="s2">&quot;Hello Rack!&quot;</span><span class="o">]</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后，我们就可以在命令行直接输入 rackup  congig.ru  这样就能启动我们的rack application了，默认启用的端口是9292，但是我们可以通过 -p参数来改变启动的端口</p>

<h2>Rack Builder</h2>

<p>在上面的例子中，我们使用了rackup，实际上当我们使用rackup启动我们的应用的时候，rackup把config文件转换成了Rackup::Builder的一个实例。</p>

<h3>what&rsquo;s Rack::Builder</h3>

<p>Rack::Builder是一个能够将各种Rack middlewares 和application 整合到一起并转换为一个rack application的东西。</p>

<h3>example</h3>

<p>比如说，我们的rack application 叫 infinity:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">infinity</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="n">env</span><span class="o">.</span><span class="n">inspect</span><span class="o">]</span><span class="p">}</span>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Mongrel</span><span class="o">.</span><span class="n">run</span> <span class="n">infinity</span><span class="p">,</span> <span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">9292</span>
</span></code></pre></td></tr></table></div></figure>


<p>如上代码所示，这个infinity所做的事就是将这个environment参数的所有内容返回到浏览器。</p>

<p>你需要关注Rack::Builder的三个实例方法:</p>

<ul>
<li><p>Rack::Builder#run</p></li>
<li><p>Rack::Builder#use</p></li>
<li><p>Rack::Builder#map</p></li>
</ul>


<p>Rack::Builder#run 指定你要用Rack::Builder包装的rack application的应用，并转换这个Rack::application为Rack::Builder的实例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">infinity</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="n">env</span><span class="o">.</span><span class="n">inspect</span><span class="o">]</span><span class="p">}</span>
</span><span class='line'><span class="n">builder</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Builder</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">builder</span><span class="o">.</span><span class="n">run</span> <span class="n">infinity</span>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Mongrel</span><span class="o">.</span><span class="n">run</span> <span class="n">builder</span><span class="p">,</span> <span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">9292</span>
</span></code></pre></td></tr></table></div></figure>


<p>或者你也可以ruby社区的惯例方式:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">infinity</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="n">env</span><span class="o">.</span><span class="n">inspect</span><span class="o">]</span><span class="p">}</span>
</span><span class='line'><span class="n">builder</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Builder</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">run</span> <span class="n">infinity</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Mongrel</span><span class="o">.</span><span class="n">run</span> <span class="n">builder</span><span class="p">,</span> <span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">9292</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rack::Builder#use 这个方法是用来添加一个middleware 到rack application 的，你可以把这个middleware当作是一个前置/后置 过滤器。 Rack gem  有许多有用的middleware，比如说，Rack::CommonLogger，这个middleware是用来帮助我们打印apache格式的日志的，如果我们想给我们的rack application 添加这个middleware的话，我们可以这样:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">infinity</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="n">env</span><span class="o">.</span><span class="n">inspect</span><span class="o">]</span><span class="p">}</span>
</span><span class='line'><span class="n">builder</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Builder</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">use</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:CommonLogger</span>
</span><span class='line'>  <span class="n">run</span> <span class="n">infinity</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Mongrel</span><span class="o">.</span><span class="n">run</span> <span class="n">builder</span><span class="p">,</span> <span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">9292</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rack::Builder#map 通过这个方法，我们可以挂在很多的middleware到我们的rack application 中指定的某个url或者其子url中,比如说，你想让用户在访问/version(比如说 /version,/version/whatever，但是不是/versionsomething)，你想要做一些特殊的事情:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">infinity</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="n">env</span><span class="o">.</span><span class="n">inspect</span><span class="o">]</span><span class="p">}</span>
</span><span class='line'><span class="n">builder</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Builder</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">use</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:CommonLogger</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">map</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="n">infinity</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">map</span> <span class="s1">&#39;/version&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="s2">&quot;infinity 0.1&quot;</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Mongrel</span><span class="o">.</span><span class="n">run</span> <span class="n">builder</span><span class="p">,</span> <span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">9292</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在，如果你访问localhost:9292的话，你会发现页面返回的是 env的信息，如果你访问的是localhost:9292/version的话，将会返回 infinity 0.1，如果你访问localhost:9292/versionsomething的话，仍然返回env的信息</p>

<h3>nesting  maps</h3>

<p>如果你想给你的rack application 路由更多的选择的话，你可以使用以下这种方法:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">infinity</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="n">env</span><span class="o">.</span><span class="n">inspect</span><span class="o">]</span><span class="p">}</span>
</span><span class='line'><span class="n">builder</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Builder</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">use</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:CommonLogger</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">map</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="n">infinity</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">map</span> <span class="s1">&#39;/version&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">map</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">run</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="s2">&quot;infinity 0.1&quot;</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">map</span> <span class="s1">&#39;/last&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">run</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="s2">&quot;infinity beta 0.0&quot;</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Mongrel</span><span class="o">.</span><span class="n">run</span> <span class="n">builder</span><span class="p">,</span> <span class="ss">:Port</span> <span class="o">=&gt;</span> <span class="mi">9292</span>
</span></code></pre></td></tr></table></div></figure>


<h3>write your own  middleware</h3>

<figure class='code'><figcaption><span>myrackmiddleware.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyRackMiddleware</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">appl</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@appl</span> <span class="o">=</span> <span class="n">appl</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>    <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="vi">@appl</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>    <span class="n">append_s</span> <span class="o">=</span> <span class="s2">&quot;... greetings from RubyLearning!!&quot;</span>
</span><span class='line'>    <span class="n">new_body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="n">body</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">string</span><span class="o">|</span> <span class="n">new_body</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">string</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">new_body</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">append_s</span>
</span><span class='line'>    <span class="o">[</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="o">[</span><span class="n">new_body</span><span class="o">]]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>my_app.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyApp</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>    <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span> <span class="o">[</span><span class="s2">&quot;Hello Rack Participants from across the globe&quot;</span><span class="o">]]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;./my_app&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;./myrackmiddleware&#39;</span>
</span><span class='line'><span class="n">use</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Reloader</span>
</span><span class='line'><span class="n">use</span> <span class="no">MyRackMiddleware</span>
</span><span class='line'><span class="n">run</span> <span class="no">MyApp</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>


<h3>another middle ware</h3>

<figure class='code'><figcaption><span>my_middleware.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">MyMiddleware</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Hello</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;/hello&#39;</span>
</span><span class='line'>        <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">},</span> <span class="o">[</span><span class="s2">&quot;Hello from the middleware!&quot;</span><span class="o">]]</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="c1"># forward the request</span>
</span><span class='line'>        <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>config.ru</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;./my_middleware&#39;</span>
</span><span class='line'><span class="n">use</span> <span class="ss">MyMiddleware</span><span class="p">:</span><span class="ss">:Hello</span> <span class="c1"># this comes in between</span>
</span><span class='line'><span class="n">run</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span><span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">},</span> <span class="o">[</span><span class="s1">&#39;Try accessing visiting /hello&#39;</span><span class="o">]]</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>最后</h2>

<p><img src="http://gaoguoxin.github.io/images/rack.jpeg" alt="rack image" /></p>

<p>上图是rack的一张简易图，可一看出，rack包含了adapters 用来链接一系列的ruby web framework，还包含handlers 用来链接支持rack的webserver。在handlers和adapters中间是一系列的middleware。middleware的背后原理就是在request到达server之前对request做一些处理，在response返回到framework之前对response做一些处理。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails_initialize]]></title>
    <link href="http://gaoguoxin.github.io/blog/2014/02/25/rails-initialize/"/>
    <updated>2014-02-25T09:26:57+00:00</updated>
    <id>http://gaoguoxin.github.io/blog/2014/02/25/rails-initialize</id>
    <content type="html"><![CDATA[<p>我们经常在我们的rails项目的根目录执行这样的操作，比如:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rails</span> <span class="n">s</span>  <span class="c1">#=&gt; 启动本地服务器，让我们的项目跑起来</span>
</span><span class='line'><span class="n">rails</span> <span class="n">c</span>  <span class="c1">#=&gt; 启动console</span>
</span><span class='line'><span class="n">rails</span> <span class="n">db</span> <span class="c1">#=&gt; 启动我们的database终端</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的命令你可能已经再熟悉不过了，但是你想过没有，为什么rails命令可以执行?难道rails是我们系统的命令么?这就设计我本文要讲的，rails的启动流成了。在你的终端输入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>which rails <span class="c">#=&gt; /home/naitnix/.rvm/gems/ruby-1.9.3-p194/bin/rails (这个路径是你的rails可执行文件的所在路径)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$PATH</span>  <span class="c">#=&gt; /home/naitnix/.rvm/gems/ruby-1.9.3-p194/bin (我们的系统环境变量)</span>
</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<p>以上输出说明，我们的rails命令是一个可执行脚本文件，并且这个脚本文件被我们添加到了系统的环境变量。下面我们来看看这个脚本的具体内容:</p>

<figure class='code'><figcaption><span>/home/naitnix/.rvm/gems/ruby-1.9.3-p194/bin/rails</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby  这句话的意思是使用系统环境变量中的ruby解释器，与shell中的  #!/usr/bin/bash不同</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># This file was generated by RubyGems.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># The application &#39;railties&#39; is installed as part of a gem, and</span>
</span><span class='line'><span class="c1"># this file is here to facilitate running it.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>  <span class="c1">#加载rubygems</span>
</span><span class='line'>
</span><span class='line'><span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;&gt;= 0&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">first</span> <span class="o">=~</span> <span class="sr">/^_(.*)_$/</span> <span class="ow">and</span> <span class="ss">Gem</span><span class="p">:</span><span class="ss">:Version</span><span class="o">.</span><span class="n">correct?</span> <span class="vg">$1</span> <span class="k">then</span>
</span><span class='line'>  <span class="n">version</span> <span class="o">=</span> <span class="vg">$1</span>
</span><span class='line'>  <span class="no">ARGV</span><span class="o">.</span><span class="n">shift</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;railties&#39;</span><span class="p">,</span> <span class="n">version</span> <span class="c1">#导入railties这个gem，这是rails中的核心概念</span>
</span><span class='line'><span class="nb">load</span> <span class="no">Gem</span><span class="o">.</span><span class="n">bin_path</span><span class="p">(</span><span class="s1">&#39;railties&#39;</span><span class="p">,</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>  <span class="c1">#加载railties目录下的rails</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我们在我们项目的根目录输入 bundle show rails 看一下我们的rails装在了哪里，他会告诉我们类似下面这样的一个路径:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sr">/home/n</span><span class="n">aitnix</span><span class="o">/.</span><span class="n">rvm</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="n">p194</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="n">rails</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">16</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我们进入这个目录查看里面的内容，你会发现里面是空的，这是怎么回事?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cd</span> <span class="sr">/home/n</span><span class="n">aitnix</span><span class="o">/.</span><span class="n">rvm</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="mi">9</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="n">p194</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="n">rails</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">16</span>
</span><span class='line'>
</span><span class='line'><span class="n">ls</span> <span class="c1"># =&gt; 空的，没有任何内容</span>
</span></code></pre></td></tr></table></div></figure>


<p>自rails3起，rails的所有的源代码都放到了railties 里面，如果我们回到 上面一个目录，你会发现有一个对应的 railties-3.2.16目录:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cd</span> <span class="o">.</span><span class="n">.</span><span class="o">/</span>
</span><span class='line'>
</span><span class='line'><span class="n">ls</span> <span class="c1">#=&gt; railties-3.2.16</span>
</span><span class='line'>
</span><span class='line'><span class="n">cd</span> <span class="n">railties</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">16</span>
</span><span class='line'>
</span><span class='line'><span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
</span><span class='line'>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span>  <span class="mi">8</span> <span class="mi">08</span><span class="p">:</span><span class="mi">56</span> <span class="n">bin</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4966</span> <span class="no">Dec</span>  <span class="mi">9</span> <span class="mo">05</span><span class="p">:</span><span class="mi">44</span> <span class="no">CHANGELOG</span><span class="o">.</span><span class="n">md</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">6</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Dec</span>  <span class="mi">9</span> <span class="mo">05</span><span class="p">:</span><span class="mi">44</span> <span class="n">guides</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">3</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Dec</span>  <span class="mi">9</span> <span class="mo">05</span><span class="p">:</span><span class="mi">44</span> <span class="n">lib</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">765</span> <span class="no">Dec</span>  <span class="mi">9</span> <span class="mo">05</span><span class="p">:</span><span class="mi">44</span> <span class="no">README</span><span class="o">.</span><span class="n">rdoc</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果你从github  clone了rails的源码的话，你会发现他的代码结构与我们上面的目录类似，只是多了几个rails的组件:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">4</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">actionmailer</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">4</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">actionpack</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">4</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">actionview</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">5</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">activemodel</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">5</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">activerecord</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">5</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">activesupport</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">ci</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">1203</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">CONTRIBUTING</span><span class="o">.</span><span class="n">md</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">2203</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">Gemfile</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">7</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">guides</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">524</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">install</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">51</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">load_paths</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">1159</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">rails</span><span class="o">.</span><span class="n">gemspec</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">10</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">RAILS_VERSION</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">5</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">railties</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">2844</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">Rakefile</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4029</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">README</span><span class="o">.</span><span class="n">md</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">7671</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">RELEASING_RAILS</span><span class="o">.</span><span class="n">rdoc</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">tasks</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">tools</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">158</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">version</span><span class="o">.</span><span class="n">rb</span>
</span></code></pre></td></tr></table></div></figure>


<p>你会看到上面的列表中有个railties目录，这个目录就是我们上面说的rails启动流程的源码目录，让我们进入这个目录看看:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">bin</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">8898</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">CHANGELOG</span><span class="o">.</span><span class="n">md</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">3</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">lib</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">1072</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">MIT</span><span class="o">-</span><span class="no">LICENSE</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">1028</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">railties</span><span class="o">.</span><span class="n">gemspec</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">1296</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">Rakefile</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">3382</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">RDOC_MAIN</span><span class="o">.</span><span class="n">rdoc</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">803</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="no">README</span><span class="o">.</span><span class="n">rdoc</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">9</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>里面有两个目录我们需要关心，一个是bin，另一个是lib，我们在这篇文章开始说的，rails可执行文件要加载一个railties目录下的rails可执行文件，这个rails可执行文件就在这个bin目录。lib目录，里面有个rails目录，这个目录里的代码才使我们真正的启动相关的代码所在:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">211</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">all</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">api</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">application</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">463</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">application_controller</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">14732</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">application</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">1950</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">app_rails_loader</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">857</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">backtrace_cleaner</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">381</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">cli</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">2087</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">code_statistics_calculator</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">2836</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">code_statistics</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">commands</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">328</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">commands</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">3619</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">configuration</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">console</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">500</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">deprecation</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">engine</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span> <span class="mi">24556</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">engine</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">9</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">generators</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">9853</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">generators</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">588</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">info_controller</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">3129</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">info</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">2276</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">initializable</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">2175</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">mailers_controller</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">5664</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">paths</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">rack</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">190</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">rack</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">railtie</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">7467</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">railtie</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">985</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">rubyprof_ext</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">302</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">ruby_version_check</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4456</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">source_annotation_extractor</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">tasks</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">188</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">tasks</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">4</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">templates</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">1218</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">test_help</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">naitnix</span> <span class="n">naitnix</span>  <span class="mi">4096</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">test_unit</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">158</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">version</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">naitnix</span> <span class="n">naitnix</span>   <span class="mi">150</span> <span class="no">Feb</span> <span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span> <span class="n">welcome_controller</span><span class="o">.</span><span class="n">rb</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我们看见一些以Rails开头的路径，多半指的是这个rails目录。</p>

<p>好，介绍完了rails的源码目录结构，我们接着我们开头的部分讲，当我们在终端输入rails 命令后，系统会到环境变量的目录中查找到rails可执行文件，并利用环境变量中的ruby解释器去解释这个文件，那么我们在前面看到了，这个文件主要做了两件是:第一时间在rubygems,第二就是 load了rails源码目录(bin/rails)中的rails命令文件，那么我们来看看这个rails可执行文件中到底做了哪些事:</p>

<figure class='code'><figcaption><span>railties/bin/rails</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../..&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">),</span> <span class="s1">&#39;.git&#39;</span><span class="p">))</span>
</span><span class='line'>  <span class="n">railties_path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../lib&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>  <span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="n">railties_path</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;rails/cli&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个文件主要是require了 /home/naitnix/.rvm/gems/ruby-1.9.3-p194/gems/railties-3.2.16/lib/rails/cli.rb这个文件，所以，让我们来看看这个cli.rb文件到底做了写什么</p>

<figure class='code'><figcaption><span>lib/rails/cli.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/app_rails_loader&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># If we are inside a Rails application this method performs an exec and thus</span>
</span><span class='line'><span class="c1"># the rest of this script is not run.</span>
</span><span class='line'><span class="ss">Rails</span><span class="p">:</span><span class="ss">:AppRailsLoader</span><span class="o">.</span><span class="n">exec_app_rails</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/ruby_version_check&#39;</span>
</span><span class='line'><span class="no">Signal</span><span class="o">.</span><span class="n">trap</span><span class="p">(</span><span class="s2">&quot;INT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="nb">puts</span><span class="p">;</span> <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">first</span> <span class="o">==</span> <span class="s1">&#39;plugin&#39;</span>
</span><span class='line'>  <span class="no">ARGV</span><span class="o">.</span><span class="n">shift</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;rails/commands/plugin&#39;</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;rails/commands/application&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个文件主要做了这么几件事:</p>

<ul>
<li>require 了 rails 目录下的app_rails_loader文件</li>
<li>执行exec_app_rails方法</li>
<li>做ruby版本的检查</li>
<li>判断rails命令后面的参数，如果跟的是plugin那么require rails/commands/plugin这个文件，否则的话，require rails/commands/application</li>
</ul>


<p>接下来，我们看看这个app_rails_loader文件中的exec_app_rails方法:</p>

<figure class='code'><figcaption><span>app_rails_loader.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RUBY</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">.</span><span class="n">ruby</span>  <span class="c1">#定义常量</span>
</span><span class='line'><span class="no">EXECUTABLES</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;bin/rails&#39;</span><span class="p">,</span> <span class="s1">&#39;script/rails&#39;</span><span class="o">]</span><span class="c1">#rails可执行文件的目录</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">exec_app_rails</span>
</span><span class='line'>  <span class="n">original_cwd</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">loop</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">exe</span> <span class="o">=</span> <span class="n">find_executable</span>
</span><span class='line'>      <span class="n">contents</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>  <span class="c1">#contents为bin/rails或者script/rails</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">contents</span> <span class="o">=~</span> <span class="sr">/(APP|ENGINE)_PATH/</span><span class="c1">#如果contents为script/rails，则表示我们当前执行rails命令的目录是我们项目的根目录</span>
</span><span class='line'>        <span class="nb">exec</span> <span class="no">RUBY</span><span class="p">,</span> <span class="n">exe</span><span class="p">,</span> <span class="o">*</span><span class="no">ARGV</span><span class="err">执行</span><span class="n">script</span><span class="o">/</span><span class="n">rails</span><span class="err">命令</span>
</span><span class='line'>        <span class="k">break</span> <span class="c1"># non reachable, hack to be able to stub exec in the test suite</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">exe</span><span class="o">.</span><span class="n">end_with?</span><span class="p">(</span><span class="s1">&#39;bin/rails&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">contents</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;This file was generated by Bundler&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="c1">#rails4 里面，移除了script目录，添加了bin目录，并将rails，bundle，rake等命令放到了这个bin目录</span>
</span><span class='line'>        <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="no">BUNDLER_WARNING</span><span class="p">)</span>
</span><span class='line'>        <span class="no">Object</span><span class="o">.</span><span class="n">const_set</span><span class="p">(</span><span class="ss">:APP_PATH</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;config/application&#39;</span><span class="p">,</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">))</span><span class="c1">#设置常量 APP_PATH</span>
</span><span class='line'>        <span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../boot&#39;</span><span class="p">,</span> <span class="no">APP_PATH</span><span class="p">)</span> <span class="c1">#require  boot.rb</span>
</span><span class='line'>        <span class="nb">require</span> <span class="s1">&#39;rails/commands&#39;</span> <span class="c1"># require lib/rails/commands.rb文件</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># If we exhaust the search there is no executable, this could be a</span>
</span><span class='line'>    <span class="c1"># call to generate a new application, so restore the original cwd.</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span> <span class="ow">and</span> <span class="k">return</span> <span class="k">if</span> <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">)</span><span class="o">.</span><span class="n">root?</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Otherwise keep moving upwards in search of an executable.</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_executable</span>
</span><span class='line'>  <span class="no">EXECUTABLES</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">exe</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>那么来看看这个script/rails(或者bin/rails)文件里都做了哪些事:</p>

<figure class='code'><figcaption><span>script/rails(bin/rails)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">APP_PATH</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../config/application&#39;</span><span class="p">,</span>  <span class="bp">__FILE__</span><span class="p">)</span><span class="c1">#设置常量 APP_PATH</span>
</span><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../config/boot&#39;</span><span class="p">,</span>  <span class="bp">__FILE__</span><span class="p">)</span><span class="c1">#require  boot.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/commands&#39;</span><span class="c1"># require lib/rails/commands.rb文件</span>
</span></code></pre></td></tr></table></div></figure>


<p>看看项目目录中的config/boot.rb文件的内容:</p>

<figure class='code'><figcaption><span>config/boot.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Set up gems listed in the Gemfile.</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;BUNDLE_GEMFILE&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../Gemfile&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;bundler/setup&#39;</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;BUNDLE_GEMFILE&#39;</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个文件的内容很简单，load  Gemfile文件并run bundler。接下来我们看一下 railties/lib/rails/commands.rb文件:</p>

<figure class='code'><figcaption><span>railties/lib/rails/commands.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ARGV</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;--help&#39;</span> <span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>
</span><span class='line'><span class="n">aliases</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1">#设置了几个常用的命令别名</span>
</span><span class='line'>  <span class="s2">&quot;g&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;generate&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;d&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;destroy&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;c&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;console&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;s&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;db&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;dbconsole&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;r&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;runner&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">command</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">shift</span>
</span><span class='line'><span class="n">command</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">[</span><span class="n">command</span><span class="o">]</span> <span class="o">||</span> <span class="n">command</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/commands/commands_tasks&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Rails</span><span class="p">:</span><span class="ss">:CommandsTasks</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="p">)</span><span class="o">.</span><span class="n">run_command!</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="c1">#执行命令方法</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>上面的执行命令的方法在rails/commands/commands_tasks.rb文件，我们来看看:</p>

<figure class='code'><figcaption><span>rails/commands/commands_tasks.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="c1"># This is a class which takes in a rails command and initiates the appropriate</span>
</span><span class='line'>  <span class="c1"># initiation sequence.</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># Warning: This class mutates ARGV because some commands require manipulating</span>
</span><span class='line'>  <span class="c1"># it before they are run.</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">CommandsTasks</span> <span class="c1"># :nodoc:</span>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:argv</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">HELP_MESSAGE</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOT</span>
</span><span class='line'><span class="sh">Usage: rails COMMAND [ARGS]</span>
</span><span class='line'>
</span><span class='line'><span class="sh">The most common rails commands are:</span>
</span><span class='line'><span class="sh"> generate    Generate new code (short-cut alias: &quot;g&quot;)</span>
</span><span class='line'><span class="sh"> console     Start the Rails console (short-cut alias: &quot;c&quot;)</span>
</span><span class='line'><span class="sh"> server      Start the Rails server (short-cut alias: &quot;s&quot;)</span>
</span><span class='line'><span class="sh"> dbconsole   Start a console for the database specified in config/database.yml</span>
</span><span class='line'><span class="sh">             (short-cut alias: &quot;db&quot;)</span>
</span><span class='line'><span class="sh"> new         Create a new Rails application. &quot;rails new my_app&quot; creates a</span>
</span><span class='line'><span class="sh">             new application called MyApp in &quot;./my_app&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sh">In addition to those, there are:</span>
</span><span class='line'><span class="sh"> application  Generate the Rails application code</span>
</span><span class='line'><span class="sh"> destroy      Undo code generated with &quot;generate&quot; (short-cut alias: &quot;d&quot;)</span>
</span><span class='line'><span class="sh"> plugin new   Generates skeleton for developing a Rails plugin</span>
</span><span class='line'><span class="sh"> runner       Run a piece of code in the application environment (short-cut alias: &quot;r&quot;)</span>
</span><span class='line'>
</span><span class='line'><span class="sh">All commands can be run with -h (or --help) for more information.</span>
</span><span class='line'><span class="no">EOT</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">COMMAND_WHITELIST</span> <span class="o">=</span> <span class="sx">%(plugin generate destroy console server dbconsole application runner new version help)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@argv</span> <span class="o">=</span> <span class="n">argv</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">run_command!</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="n">command</span> <span class="o">=</span> <span class="n">parse_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="no">COMMAND_WHITELIST</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">send</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">write_error_message</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">plugin</span>
</span><span class='line'>      <span class="n">require_command!</span><span class="p">(</span><span class="s2">&quot;plugin&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">generate</span>
</span><span class='line'>      <span class="n">generate_or_destroy</span><span class="p">(</span><span class="ss">:generate</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>      <span class="n">generate_or_destroy</span><span class="p">(</span><span class="ss">:destroy</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">console</span>
</span><span class='line'>      <span class="n">require_command!</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Console</span><span class="o">.</span><span class="n">parse_arguments</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># RAILS_ENV needs to be set before config/application is required</span>
</span><span class='line'>      <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RAILS_ENV&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:environment</span><span class="o">]</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:environment</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># shift ARGV so IRB doesn&#39;t freak</span>
</span><span class='line'>      <span class="n">shift_argv!</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">require_application_and_environment!</span>
</span><span class='line'>      <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Console</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">server</span>
</span><span class='line'>      <span class="n">set_application_directory!</span>
</span><span class='line'>      <span class="n">require_command!</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Server</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
</span><span class='line'>        <span class="c1"># We need to require application after the server sets environment,</span>
</span><span class='line'>        <span class="c1"># otherwise the --environment option given to the server won&#39;t propagate.</span>
</span><span class='line'>        <span class="nb">require</span> <span class="no">APP_PATH</span>
</span><span class='line'>        <span class="no">Dir</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
</span><span class='line'>        <span class="n">server</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">dbconsole</span>
</span><span class='line'>      <span class="n">require_command!</span><span class="p">(</span><span class="s2">&quot;dbconsole&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="ss">Rails</span><span class="p">:</span><span class="ss">:DBConsole</span><span class="o">.</span><span class="n">start</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">application</span>
</span><span class='line'>      <span class="n">require_command!</span><span class="p">(</span><span class="s2">&quot;application&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">runner</span>
</span><span class='line'>      <span class="n">require_command!</span><span class="p">(</span><span class="s2">&quot;runner&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>      <span class="k">if</span> <span class="sx">%w(-h --help)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">argv</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
</span><span class='line'>        <span class="n">require_command!</span><span class="p">(</span><span class="s2">&quot;application&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">exit_with_initialization_warning!</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">version</span>
</span><span class='line'>      <span class="n">argv</span><span class="o">.</span><span class="n">unshift</span> <span class="s1">&#39;--version&#39;</span>
</span><span class='line'>      <span class="n">require_command!</span><span class="p">(</span><span class="s2">&quot;application&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">help</span>
</span><span class='line'>      <span class="n">write_help_message</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">exit_with_initialization_warning!</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;Can&#39;t initialize a new Rails application within the directory of another, please change to a non-Rails directory first.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;Type &#39;rails&#39; for help.&quot;</span>
</span><span class='line'>        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">shift_argv!</span>
</span><span class='line'>        <span class="n">argv</span><span class="o">.</span><span class="n">shift</span> <span class="k">if</span> <span class="n">argv</span><span class="o">.</span><span class="n">first</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">require_command!</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">require</span> <span class="s2">&quot;rails/commands/</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">generate_or_destroy</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">require</span> <span class="s1">&#39;rails/generators&#39;</span>
</span><span class='line'>        <span class="n">require_application_and_environment!</span>
</span><span class='line'>        <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">load_generators</span>
</span><span class='line'>        <span class="nb">require</span> <span class="s2">&quot;rails/commands/</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Change to the application&#39;s path if there is no config.ru file in current directory.</span>
</span><span class='line'>      <span class="c1"># This allows us to run `rails server` from other directories, but still get</span>
</span><span class='line'>      <span class="c1"># the main config.ru and properly set the tmp directory.</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">set_application_directory!</span>
</span><span class='line'>        <span class="no">Dir</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">,</span> <span class="no">APP_PATH</span><span class="p">))</span> <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;config.ru&quot;</span><span class="p">))</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">require_application_and_environment!</span>
</span><span class='line'>        <span class="nb">require</span> <span class="no">APP_PATH</span>
</span><span class='line'>        <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">require_environment!</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">write_help_message</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="no">HELP_MESSAGE</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">write_error_message</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;Error: Command &#39;</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">&#39; not recognized&quot;</span>
</span><span class='line'>        <span class="k">if</span> <span class="sx">%x{rake </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="sx"> --dry-run 2&gt;&amp;1 }</span> <span class="o">&amp;&amp;</span> <span class="vg">$?</span><span class="o">.</span><span class="n">success?</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Did you mean: `$ rake </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">` ?</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">write_help_message</span>
</span><span class='line'>        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">parse_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">command</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;--version&#39;</span><span class="p">,</span> <span class="s1">&#39;-v&#39;</span>
</span><span class='line'>          <span class="s1">&#39;version&#39;</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;--help&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span>
</span><span class='line'>          <span class="s1">&#39;help&#39;</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">command</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>看一下server这个方法，首先跳转到项目根目录，紧接着require commonds/server.rb这个文件，接着，new了一个Rails::Server的实例并启动这个server，接下来我们看看server.rb的内容：</p>

<figure class='code'><figcaption><span>server.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="o">::</span><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Server</span>  <span class="c1">#继承了Rack::Server，说明我们的rails应用也是一个Rack application</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span>
</span><span class='line'>    <span class="n">set_environment</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_environment</span>
</span><span class='line'>    <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;RAILS_ENV&quot;</span><span class="o">]</span> <span class="o">||=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:environment</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">start</span>   <span class="c1"># 重写了Rack::Server的start方法</span>
</span><span class='line'>    <span class="n">print_boot_information</span>
</span><span class='line'>    <span class="nb">trap</span><span class="p">(</span><span class="ss">:INT</span><span class="p">)</span> <span class="p">{</span> <span class="nb">exit</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">create_tmp_directories</span>
</span><span class='line'>    <span class="n">log_to_stdout</span> <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:log_stdout</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">super</span> <span class="c1">#调用Rack::Server的start方法</span>
</span><span class='line'>  <span class="k">ensure</span>
</span><span class='line'>    <span class="c1"># The &#39;-h&#39; option calls exit before @options is set.</span>
</span><span class='line'>    <span class="c1"># If we call &#39;options&#39; with it unset, we get double help banners.</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s1">&#39;Exiting&#39;</span> <span class="k">unless</span> <span class="vi">@options</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="o">[</span><span class="ss">:daemonize</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">print_boot_information</span>
</span><span class='line'>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:SSLEnable</span><span class="o">]</span> <span class="p">?</span> <span class="s1">&#39;https&#39;</span> <span class="p">:</span> <span class="s1">&#39;http&#39;</span><span class="si">}</span><span class="s2">://</span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:Host</span><span class="o">]</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:Port</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;=&gt; Booting </span><span class="si">#{</span><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Inflector</span><span class="o">.</span><span class="n">demodulize</span><span class="p">(</span><span class="n">server</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;=&gt; Rails </span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2"> application starting in </span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="si">}</span><span class="s2"> on </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;=&gt; Run `rails server -h` for more startup options&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:Host</span><span class="o">].</span><span class="n">to_s</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/0\.0\.0\.0/</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;=&gt; Notice: server is listening on all interfaces (</span><span class="si">#{</span><span class="n">options</span><span class="o">[</span><span class="ss">:Host</span><span class="o">]</span><span class="si">}</span><span class="s2">). Consider using 127.0.0.1 (--binding option)&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;=&gt; Ctrl-C to shutdown server&quot;</span> <span class="k">unless</span> <span class="n">options</span><span class="o">[</span><span class="ss">:daemonize</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create_tmp_directories</span>
</span><span class='line'>    <span class="sx">%w(cache pids sessions sockets)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir_to_make</span><span class="o">|</span>
</span><span class='line'>      <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">,</span> <span class="n">dir_to_make</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">log_to_stdout</span>
</span><span class='line'>    <span class="n">wrapped_app</span> <span class="c1"># touch the app so the logger is set up</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">console</span> <span class="o">=</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vg">$stdout</span><span class="p">)</span>
</span><span class='line'>    <span class="n">console</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">formatter</span>
</span><span class='line'>    <span class="n">console</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">level</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Logger</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">console</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">default_options</span>  <span class="c1">#重写了Rack的default_options，这里你可以修改端口号，设置启动环境的优先级，及pid文件位置和config.ru文件的路径</span>
</span><span class='line'>  <span class="k">super</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span>
</span><span class='line'>    <span class="ss">Port</span><span class="p">:</span>               <span class="mi">3000</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">DoNotReverseLookup</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">environment</span><span class="p">:</span>        <span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RAILS_ENV&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RACK_ENV&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;development&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dup</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">daemonize</span><span class="p">:</span>          <span class="kp">false</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">debugger</span><span class="p">:</span>           <span class="kp">false</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">pid</span><span class="p">:</span>                <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;tmp/pids/server.pid&quot;</span><span class="p">),</span>
</span><span class='line'>    <span class="ss">config</span><span class="p">:</span>             <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;config.ru&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到这个server继承了Rack::Server，说明，我们的rails 项目也是一个Rack application, rack  application  在启动的时候会去寻找一个叫做config.ru的文件:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../config/environment&#39;</span><span class="p">,</span>  <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="n">run</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个文件 require了config/enviromnent.rb 文件，并启动我们的application，这样我们的server就启动起来了。那么我们的服务启动的时候是怎么加载我们的项目的呢，让我们看一下 config/environment.rb文件:</p>

<figure class='code'><figcaption><span>config/environment.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Load the Rails application.</span>
</span><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../application&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Initialize the Rails application.</span>
</span><span class='line'><span class="ss">R4pro</span><span class="p">:</span><span class="ss">:Application</span><span class="o">.</span><span class="n">initialize!</span>
</span></code></pre></td></tr></table></div></figure>


<p>看上面的代码，这个文件只做了两件事:加载application.rb 文件 初始化我们的项目。我们先来看看这个application.rb文件:</p>

<figure class='code'><figcaption><span>config/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../boot&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails/all&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Require the gems listed in Gemfile, including any gems</span>
</span><span class='line'><span class="c1"># you&#39;ve limited to :test, :development, or :production.</span>
</span><span class='line'><span class="no">Bundler</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">R4pro</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Application</span>
</span><span class='line'>    <span class="c1"># Settings in config/environments/* take precedence over those specified here.</span>
</span><span class='line'>    <span class="c1"># Application configuration should go into files in config/initializers</span>
</span><span class='line'>    <span class="c1"># -- all .rb files in that directory are automatically loaded.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Set Time.zone default to the specified zone and make Active Record auto-convert to this zone.</span>
</span><span class='line'>    <span class="c1"># Run &quot;rake -D time&quot; for a list of tasks for finding time zone names. Default is UTC.</span>
</span><span class='line'>    <span class="c1"># config.time_zone = &#39;Central Time (US &amp; Canada)&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># The default locale is :en and all translations from config/locales/*.rb,yml are auto loaded.</span>
</span><span class='line'>    <span class="c1"># config.i18n.load_path += Dir[Rails.root.join(&#39;my&#39;, &#39;locales&#39;, &#39;*.{rb,yml}&#39;).to_s]</span>
</span><span class='line'>    <span class="c1"># config.i18n.default_locale = :de</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个文件的第一行，require  boot.rb 文件，这个文件我们在上面说过，就是load Gemfile文件，并run  bundler 。紧接着第二行，require 了 railties/lib/rails/all.rb文件，这个all文件的内容:</p>

<figure class='code'><figcaption><span>all.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;rails&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">%w(</span>
</span><span class='line'><span class="sx">  active_record</span>
</span><span class='line'><span class="sx">  action_controller</span>
</span><span class='line'><span class="sx">  action_view</span>
</span><span class='line'><span class="sx">  action_mailer</span>
</span><span class='line'><span class="sx">  rails/test_unit</span>
</span><span class='line'><span class="sx">  sprockets</span>
</span><span class='line'><span class="sx">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">framework</span><span class="o">|</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">framework</span><span class="si">}</span><span class="s2">/railtie&quot;</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="no">LoadError</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>第一行，require了 lib/rails.rb文件，接下来，加载rails的各个模块下的railtie文件。接下来继续看config/application.rb</p>

<figure class='code'><figcaption><span>application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">R4pro</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Application</span>
</span><span class='line'>    <span class="c1"># Settings in config/environments/* take precedence over those specified here.</span>
</span><span class='line'>    <span class="c1"># Application configuration should go into files in config/initializers</span>
</span><span class='line'>    <span class="c1"># -- all .rb files in that directory are automatically loaded.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Set Time.zone default to the specified zone and make Active Record auto-convert to this zone.</span>
</span><span class='line'>    <span class="c1"># Run &quot;rake -D time&quot; for a list of tasks for finding time zone names. Default is UTC.</span>
</span><span class='line'>    <span class="c1"># config.time_zone = &#39;Central Time (US &amp; Canada)&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># The default locale is :en and all translations from config/locales/*.rb,yml are auto loaded.</span>
</span><span class='line'>    <span class="c1"># config.i18n.load_path += Dir[Rails.root.join(&#39;my&#39;, &#39;locales&#39;, &#39;*.{rb,yml}&#39;).to_s]</span>
</span><span class='line'>    <span class="c1"># config.i18n.default_locale = :de</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个 class Application 继承自 Rails::Application，这个class将会在Rackup 文件中被传递到Rack server。我们再来看看Rails::Application</p>

<figure class='code'><figcaption><span>rails/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Engine</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inherited</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span> <span class="c1">#调用Engine的super</span>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">application</span> <span class="o">||=</span> <span class="n">base</span><span class="o">.</span><span class="n">instance</span> <span class="c1">#这个Rails是在lib/rails.rb中定义的一个module，这个application是它的一个attributes</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">config</span>  <span class="c1">#这个及时我们rails项目中的config/application.rb 文件中的config 注意这个方法是个类方法，这样我们在我们的项目的config/application.rb文件中才可以使用config直接调用</span>
</span><span class='line'>    <span class="vi">@config</span> <span class="o">||=</span> <span class="ss">Application</span><span class="p">:</span><span class="ss">:Configuration</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">find_root_with_flag</span><span class="p">(</span><span class="s2">&quot;config.ru&quot;</span><span class="p">,</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">))</span>  <span class="c1">#这个配置在rails/application/configuration.rb文件</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个Application 类继承了 Engine，这就是说，我们的rails application 也是一个engine。当一个类继承了这个类的时候，base.instance 将会赋值到Rails.application ,这个base.instance将会创建一个我们项目的实例。这就是说，我们可以在我们的项目的任何一个地方使用Rails.application来访问我们的项目的实例。我们看看Engine.rb文件:</p>

<figure class='code'><figcaption><span>rails/engine.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Engine</span> <span class="o">&lt;</span> <span class="no">Railtie</span>  <span class="c1">#继承自 Railtie 类</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Configuration</span><span class="p">,</span> <span class="s2">&quot;rails/engine/configuration&quot;</span> <span class="c1">#加载 enging/configuration.rb这个文件</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">inherited</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">base</span><span class="o">.</span><span class="n">abstract_railtie?</span>
</span><span class='line'>    <span class="ss">Rails</span><span class="p">:</span><span class="ss">:Railtie</span><span class="o">::</span><span class="no">Configuration</span><span class="o">.</span><span class="n">eager_load_namespaces</span> <span class="o">&lt;&lt;</span> <span class="n">base</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">called_from</span> <span class="o">=</span> <span class="k">begin</span>
</span><span class='line'>      <span class="n">call_stack</span> <span class="o">=</span> <span class="k">if</span> <span class="no">Kernel</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:caller_locations</span><span class="p">)</span>
</span><span class='line'>        <span class="n">caller_locations</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:path</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="c1"># Remove the line number from backtraces making sure we don&#39;t leave anything behind</span>
</span><span class='line'>        <span class="nb">caller</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sr">/:\d+.*/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">call_stack</span><span class="o">.</span><span class="n">detect</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span> <span class="o">!~</span> <span class="sr">%r[railties[\w.-]*/lib/rails|rack[\w.-]*/lib/rack]</span> <span class="p">})</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">super</span>  <span class="c1">#调用Railtie这个类的inherited</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">instance</span>  <span class="c1">#这个instance方法就是我们在application.rb 文件中 base.instance的出处</span>
</span><span class='line'>  <span class="vi">@instance</span> <span class="o">||=</span> <span class="kp">new</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个Engine类继承了Railtie类，Railtie几乎遍布所有的ruby gems ，任何想要集成到rails项目的gems都应该有它自己的railtie。我们看看Railtie:</p>

<figure class='code'><figcaption><span>rails/railtie.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Railtie</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Configuration</span><span class="p">,</span> <span class="s2">&quot;rails/railtie/configuration&quot;</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">inherited</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="n">base</span><span class="o">.</span><span class="n">abstract_railtie?</span>
</span><span class='line'>        <span class="n">subclasses</span> <span class="o">&lt;&lt;</span> <span class="n">base</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个类没有继承其他的类，但是他include了一个confirugration.rb 文件，无论这个Railtie类什么时候被继承，这个文件都会被加载。 我们再来看看关于网站配置的文件,在rails/application.rb文件中，include了  lib/rails/application/configuration.rb 文件:</p>

<figure class='code'><figcaption><span>appalication/configuration.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Application</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Configuration</span> <span class="o">&lt;</span> <span class="o">::</span><span class="ss">Rails</span><span class="p">:</span><span class="ss">:Engine</span><span class="o">::</span><span class="no">Configuration</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'>        <span class="k">super</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
</span><span class='line'>        <span class="vi">@allow_concurrency</span>             <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="vi">@consider_all_requests_local</span>   <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>        <span class="vi">@filter_parameters</span>             <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>        <span class="vi">@filter_redirect</span>               <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>        <span class="vi">@helpers_paths</span>                 <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>        <span class="vi">@serve_static_assets</span>           <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>        <span class="vi">@static_cache_control</span>          <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="vi">@force_ssl</span>                     <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>        <span class="vi">@ssl_options</span>                   <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>        <span class="vi">@session_store</span>                 <span class="o">=</span> <span class="ss">:cookie_store</span>
</span><span class='line'>        <span class="vi">@session_options</span>               <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>        <span class="vi">@time_zone</span>                     <span class="o">=</span> <span class="s2">&quot;UTC&quot;</span>
</span><span class='line'>        <span class="vi">@beginning_of_week</span>             <span class="o">=</span> <span class="ss">:monday</span>
</span><span class='line'>        <span class="vi">@log_level</span>                     <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="vi">@middleware</span>                    <span class="o">=</span> <span class="n">app_middleware</span>
</span><span class='line'>        <span class="vi">@generators</span>                    <span class="o">=</span> <span class="n">app_generators</span>
</span><span class='line'>        <span class="vi">@cache_store</span>                   <span class="o">=</span> <span class="o">[</span> <span class="ss">:file_store</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">root</span><span class="si">}</span><span class="s2">/tmp/cache/&quot;</span> <span class="o">]</span>
</span><span class='line'>        <span class="vi">@railties_order</span>                <span class="o">=</span> <span class="o">[</span><span class="ss">:all</span><span class="o">]</span>
</span><span class='line'>        <span class="vi">@relative_url_root</span>             <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;RAILS_RELATIVE_URL_ROOT&quot;</span><span class="o">]</span>
</span><span class='line'>        <span class="vi">@reload_classes_only_on_change</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>        <span class="vi">@file_watcher</span>                  <span class="o">=</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:FileUpdateChecker</span>
</span><span class='line'>        <span class="vi">@exceptions_app</span>                <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="vi">@autoflush_log</span>                 <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>        <span class="vi">@log_formatter</span>                 <span class="o">=</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Logger</span><span class="o">::</span><span class="no">SimpleFormatter</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>        <span class="vi">@eager_load</span>                    <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="vi">@secret_token</span>                  <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="vi">@secret_key_base</span>               <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>
</span><span class='line'>        <span class="vi">@assets</span> <span class="o">=</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:OrderedOptions</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">enabled</span>                  <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">paths</span>                    <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">precompile</span>               <span class="o">=</span> <span class="o">[</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">path</span><span class="p">,</span> <span class="n">fn</span><span class="o">|</span> <span class="n">fn</span> <span class="o">=~</span> <span class="sr">/app\/assets/</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="sx">%w(.js .css)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">extname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="p">},</span>
</span><span class='line'>                                             <span class="sr">/(?:\/|\\|\A)application\.(css|js)$/</span> <span class="o">]</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">prefix</span>                   <span class="o">=</span> <span class="s2">&quot;/assets&quot;</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">version</span>                  <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">debug</span>                    <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">compile</span>                  <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">digest</span>                   <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">cache_store</span>              <span class="o">=</span> <span class="o">[</span> <span class="ss">:file_store</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">root</span><span class="si">}</span><span class="s2">/tmp/cache/assets/</span><span class="si">#{</span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="si">}</span><span class="s2">/&quot;</span> <span class="o">]</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">js_compressor</span>            <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">css_compressor</span>           <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>        <span class="vi">@assets</span><span class="o">.</span><span class="n">logger</span>                   <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个Configurationl类在初始化的时候定义了很多的实例变量，这些变量大部分我们在做我们项目的配置的时候都见过。并且，这个类继承了::Rails::Engine::Configuration，我们再看看这个类:</p>

<figure class='code'><figcaption><span>engine/configuration.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Engine</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Configuration</span> <span class="o">&lt;</span> <span class="o">::</span><span class="ss">Rails</span><span class="p">:</span><span class="ss">:Railtie</span><span class="o">::</span><span class="no">Configuration</span>
</span><span class='line'>      <span class="kp">attr_reader</span> <span class="ss">:root</span>
</span><span class='line'>      <span class="kp">attr_writer</span> <span class="ss">:middleware</span><span class="p">,</span> <span class="ss">:eager_load_paths</span><span class="p">,</span> <span class="ss">:autoload_once_paths</span><span class="p">,</span> <span class="ss">:autoload_paths</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="k">super</span><span class="p">()</span>
</span><span class='line'>        <span class="vi">@root</span> <span class="o">=</span> <span class="n">root</span>
</span><span class='line'>        <span class="vi">@generators</span> <span class="o">=</span> <span class="n">app_generators</span><span class="o">.</span><span class="n">dup</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个类继承了railtie 下的configuration类:</p>

<figure class='code'><figcaption><span>railtie/configuration.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Rails</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Railtie</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Configuration</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>        <span class="vc">@@options</span> <span class="o">||=</span> <span class="p">{}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="n">ene</span>
</span></code></pre></td></tr></table></div></figure>


<p>看过了上面的代码之后，我们再看最后一个文件，这个文件就是在config/environment.rb 文件中的最后一行的方法:</p>

<figure class='code'><figcaption><span>config/environment.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Load the rails application</span>
</span><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../application&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Initialize the rails application</span>
</span><span class='line'><span class="ss">QuillExpress</span><span class="p">:</span><span class="ss">:Application</span><span class="o">.</span><span class="n">initialize!</span>
</span></code></pre></td></tr></table></div></figure>


<p>看一下最后一行，这一行就是我们项目的初始化过程，这个过程的实现在lib/rails/application.rb文件:</p>

<figure class='code'><figcaption><span>rails/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">initialize!</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="ss">:default</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>  <span class="k">raise</span> <span class="s2">&quot;Application has been already initialized.&quot;</span> <span class="k">if</span> <span class="vi">@initialized</span>
</span><span class='line'>  <span class="n">run_initializers</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span> <span class="c1">#执行初始化</span>
</span><span class='line'>  <span class="vi">@initialized</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="nb">self</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来看看run_initializers方法在哪</p>

<figure class='code'><figcaption><span>initializable.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">run_initializers</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="ss">:default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@ran</span><span class="p">)</span>
</span><span class='line'>    <span class="n">initializers</span><span class="o">.</span><span class="n">tsort_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">initializer</span><span class="o">|</span>
</span><span class='line'>      <span class="n">initializer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">initializer</span><span class="o">.</span><span class="n">belongs_to?</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@ran</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Active_support_lazy_load_hooks]]></title>
    <link href="http://gaoguoxin.github.io/blog/2014/02/25/active-support-lazy-load-hooks/"/>
    <updated>2014-02-25T08:42:32+00:00</updated>
    <id>http://gaoguoxin.github.io/blog/2014/02/25/active-support-lazy-load-hooks</id>
    <content type="html"><![CDATA[<p>在rails的源码中经常看到有ActiveSupport.on_load这样的代码出现，于是找到代码的定义处(active_support/lazy_load_hooks.rb)中，里面的代码很简单，但是为我们提供的功能却很强大，下面我们来看一下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@load_hooks</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span> <span class="p">}</span> <span class="c1">#定义一个空的hash,用来存放还没有被执行的blocks</span>
</span><span class='line'><span class="vi">@loaded</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span> <span class="p">}</span> <span class="c1">#定义一个空hash,这个空hash主要用来存放已经被加载的载体类。</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">on_load</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span><span class="c1">#这个方法是见到最多的，很多我们需要将来执行的代码块儿都是通过这个方法存储的</span>
</span><span class='line'>  <span class="vi">@loaded</span><span class="o">[</span><span class="nb">name</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">base</span><span class="o">|</span>
</span><span class='line'>    <span class="n">execute_hook</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@load_hooks</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">block</span><span class="p">,</span> <span class="n">options</span><span class="o">]</span> <span class="c1">#每次调用该方法时，该方法后面block要执行的动作都被暂时保存在这个变量中</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">execute_hook</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="c1">#这个方法主要是用来执行存储的代码用</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">options</span><span class="o">[</span><span class="ss">:yield</span><span class="o">]</span>
</span><span class='line'>    <span class="n">block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">run_load_hooks</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="no">Object</span><span class="p">)</span> <span class="c1">#执行开始的地方，当某个文件require了这个module之后，并切调用了这个方法之后，执行开始</span>
</span><span class='line'>  <span class="vi">@loaded</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="n">base</span>
</span><span class='line'>  <span class="vi">@load_hooks</span><span class="o">[</span><span class="nb">name</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">hook</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span>
</span><span class='line'>    <span class="n">execute_hook</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">hook</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面来看一下这个azy_load_hooks用在什么地方，我们打开active_record/railtie.rb这个文件，我们会看见很多类似的代码:</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveSupport</span><span class="o">.</span><span class="n">on_load</span><span class="p">(</span><span class="ss">:active_record</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">filename</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">paths</span><span class="o">[</span><span class="s2">&quot;db&quot;</span><span class="o">].</span><span class="n">first</span><span class="p">,</span> <span class="s2">&quot;schema_cache.dump&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cache</span> <span class="o">=</span> <span class="no">Marshal</span><span class="o">.</span><span class="n">load</span> <span class="no">File</span><span class="o">.</span><span class="n">binread</span> <span class="n">filename</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migrator</span><span class="o">.</span><span class="n">current_version</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">schema_cache</span> <span class="o">=</span> <span class="n">cache</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nb">warn</span> <span class="s2">&quot;Ignoring db/schema_cache.dump because it has expired. The current schema version is </span><span class="si">#{</span><span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migrator</span><span class="o">.</span><span class="n">current_version</span><span class="si">}</span><span class="s2">, but the one in the cache is </span><span class="si">#{</span><span class="n">cache</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>方法后的block是我们真正要做的额外的操作这些操作可能会延长我们的app的启动的过程，所以，我们在这里使用on_load将这些要执行的方法暂时存放在一个变量里，只有在程序需要的时候才去执行这些额外的操作，这样的话，我们的app启动的就会更快</p>

<p>最后的执行是在active_record/base.rb文件中，代码的最下面执行到了run_load_hooks方法:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ActiveSupport</span><span class="o">.</span><span class="n">run_load_hooks</span><span class="p">(</span><span class="ss">:active_record</span><span class="p">,</span> <span class="no">Base</span><span class="p">)</span> <span class="c1">#调用run_load_hooks，额外的操作开始执行。</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果你打开rails其他的railtie的话，你会发现也有azy_load_blocks方法，他们起到的作用都是一样的，即，提高我们应用启动的速度</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Active_support_autoload]]></title>
    <link href="http://gaoguoxin.github.io/blog/2014/02/25/active-support-autoload/"/>
    <updated>2014-02-25T05:43:38+00:00</updated>
    <id>http://gaoguoxin.github.io/blog/2014/02/25/active-support-autoload</id>
    <content type="html"><![CDATA[<p>在看rails源码的时候发现很多地方用到了autoload，意识到这个autoload是整个框架的基础方法，于是有时间看了遍里面的代码，关键的方法都定义在autoload.rb(active_support/dependencies/autoload.rb)下面我们来看下这个文件里面都做了些什么事:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>  <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@_autoloads</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#hash 盛放该module需要一次性require的文件,每个元素的key为大写的module的名字，value为该module对应的文件(包含路径)</span>
</span><span class='line'>    <span class="vi">@_under_path</span> <span class="o">=</span> <span class="kp">nil</span> <span class="c1">#字符串，代表需要load的某个模块的路径</span>
</span><span class='line'>    <span class="vi">@_at_path</span> <span class="o">=</span> <span class="kp">nil</span>    <span class="c1">#字符串，代表需要load的某个模块的路径</span>
</span><span class='line'>    <span class="vi">@_eager_autoload</span> <span class="o">=</span> <span class="kp">false</span> <span class="c1">#标识位</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上代码，很明显，给base(某个可能extend ActiveSupport::Autoload的模块)声明了几个实例变量。</p>

<!--more-->


<p>再来看看autoload方法,这个方法是我们在rails源码中看到最多的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">autoload</span><span class="p">(</span><span class="n">const_name</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="vi">@_at_path</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">path</span>
</span><span class='line'>    <span class="n">full</span> <span class="o">=</span> <span class="o">[</span><span class="nb">name</span><span class="p">,</span> <span class="vi">@_under_path</span><span class="p">,</span> <span class="n">const_name</span><span class="o">.</span><span class="n">to_s</span><span class="o">].</span><span class="n">compact</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span><span class="c1">#生成一个用::隔开的字符串</span>
</span><span class='line'>    <span class="n">path</span> <span class="o">=</span> <span class="no">Inflector</span><span class="o">.</span><span class="n">underscore</span><span class="p">(</span><span class="n">full</span><span class="p">)</span><span class="c1">#生成要加载模块的路径 例如:ActiveSupport #=&gt; active_support</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@_eager_autoload</span>
</span><span class='line'>    <span class="vi">@_autoloads</span><span class="o">[</span><span class="n">const_name</span><span class="o">]</span> <span class="o">=</span> <span class="n">path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">super</span> <span class="n">const_name</span><span class="p">,</span> <span class="n">path</span> <span class="c1">#调用ruby的autoload方法，这个方法是一个懒加载，即只有用到模块中的方法或者变量的时候，才会去require该文件</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来的几个方法:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">autoload_under</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@_under_path</span><span class="p">,</span> <span class="n">old_path</span> <span class="o">=</span> <span class="n">path</span><span class="p">,</span> <span class="vi">@_under_path</span> <span class="c1">#设置了@_under_path变量</span>
</span><span class='line'>  <span class="k">yield</span>
</span><span class='line'><span class="k">ensure</span>
</span><span class='line'>  <span class="vi">@_under_path</span> <span class="o">=</span> <span class="n">old_path</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">autoload_at</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@_at_path</span><span class="p">,</span> <span class="n">old_path</span> <span class="o">=</span> <span class="n">path</span><span class="p">,</span> <span class="vi">@_at_path</span><span class="c1">#设置了@_at_path变量</span>
</span><span class='line'>  <span class="k">yield</span>
</span><span class='line'><span class="k">ensure</span>
</span><span class='line'>  <span class="vi">@_at_path</span> <span class="o">=</span> <span class="n">old_path</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">eager_autoload</span> <span class="c1">#这个方法用来一次性require所有所需的文件</span>
</span><span class='line'>  <span class="n">old_eager</span><span class="p">,</span> <span class="vi">@_eager_autoload</span> <span class="o">=</span> <span class="vi">@_eager_autoload</span><span class="p">,</span> <span class="kp">true</span><span class="c1">#设置了@_eager_autoload变量为true</span>
</span><span class='line'>  <span class="k">yield</span>
</span><span class='line'><span class="k">ensure</span>
</span><span class='line'>  <span class="vi">@_eager_autoload</span> <span class="o">=</span> <span class="n">old_eager</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上这三个方法都是后面跟着block的，所以这三个函数都yield了这个block，并且设置了base模块的几个基本的实例变量，这些block中的内容，如果你才看看rails源码的话，你会发现，基本上都是在里面调用了autoload方法:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">autoload_under</span> <span class="s2">&quot;renderer&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Renderer</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:AbstractRenderer</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:PartialRenderer</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:TemplateRenderer</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:StreamingTemplateRenderer</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">autoload_at</span> <span class="s2">&quot;action_view/template/resolver&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Resolver</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:PathResolver</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:OptimizedFileSystemResolver</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:FallbackFileSystemResolver</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">eager_autoload</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Base</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Context</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:CompiledTemplates</span><span class="p">,</span> <span class="s2">&quot;action_view/context&quot;</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Digestor</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Helpers</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:LookupContext</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Layouts</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:PathSet</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:RecordIdentifier</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Rendering</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:RoutingUrlFor</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Template</span>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:ViewPaths</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>这个时候我们回过头来在来看 autoload方法，里面有这么一句:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="vi">@_eager_autoload</span>
</span><span class='line'>  <span class="vi">@_autoloads</span><span class="o">[</span><span class="n">const_name</span><span class="o">]</span> <span class="o">=</span> <span class="n">path</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>也就是说，只要我们调用了eager_autoload这个方法，我们就会设置@<em>eager_autoload值为true，并且我们还设置了@</em>autoloads这个hash，这个hash就是用来盛放我们将来需要一次性require的文件的路径</p>

<p>再来看看最重要的一个方法:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">eager_load!</span>
</span><span class='line'>  <span class="vi">@_autoloads</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="nb">require</span> <span class="n">file</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法是我们最终实现饥饿加载的最终代码所在，即一次性require我们所需的所有的module文件。</p>

<p>这个autoload模块就是用来方便我们require我们所需要的module文件的,如果一个module extend了这个autoload模块的话，那么他就可以利用autoload这个方法来加载同一个module 名命名的文件加下的其他模块文件而不用制定文件的路径。还可以通过eager_autoload方法来指定这个module需要批量require 的module的名字，然后通过 eager_load!方法就可以实现一次性require多个文件，这个方法的好处是避免了我们在文件的开头写很多的require，如下面的例子所示:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">MyLib</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Autoload</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">autoload</span> <span class="ss">:Model</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">eager_autoload</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">autoload</span> <span class="ss">:Cache</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Then</span> <span class="n">your</span> <span class="n">library</span> <span class="n">can</span> <span class="n">be</span> <span class="n">eager</span> <span class="n">loaded</span> <span class="n">by</span> <span class="n">simply</span> <span class="ss">calling</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="no">MyLib</span><span class="o">.</span><span class="n">eager_load!</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ActiveSupport::Concern Source Code Analyse]]></title>
    <link href="http://gaoguoxin.github.io/blog/2014/02/21/hello-world/"/>
    <updated>2014-02-21T02:44:45+00:00</updated>
    <id>http://gaoguoxin.github.io/blog/2014/02/21/hello-world</id>
    <content type="html"><![CDATA[<p>1、首先我们来看个例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">M</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="no">ClassMethods</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="no">InstanceMethods</span><span class="p">)</span>
</span><span class='line'>    <span class="n">scope</span> <span class="ss">:disabled</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">:disabled</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>    <span class="c1">#...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">InstanceMethods</span>
</span><span class='line'>    <span class="c1">#...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是一个再普通不过的module了，当某个模块(或者类)include它以后，它让目标模块(或者类)去txtend  ClassMethods 这个模块，并去include  InstanceMethods 这个模块，这样的话，目标模块(或者类)在include M 的时候，这个目标模块(或者类)就拥有了ClassMethods这个模块中定义的方法并把这些方法当作类方法，并拥有了InstanceMethods模块的方法，并把这个模块中的方法作为自己的实例方法。如果你不觉得麻烦的话，那么这种方式是可选的或者，干脆直接定义实例方法，而不定义InstanceMethods，因为在include一个module的时候，module里面定义的方法自动就为实例方法。</p>

<!-- more -->


<p>2、再来看看另外一个例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Foo</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">method_injected_by_foo</span>
</span><span class='line'>        <span class="c1">#...对宿主做某些操作，例如增強功能等等</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Bar</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">method_injected_by_foo</span> <span class="c1">#这里调用了Foo这个module定义的method_injected_by_foo方法</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Host</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Foo</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Bar</span>
</span><span class='line'>  <span class="c1">#要想让让Bar被include的时候执行Foo这个module中定义的method_injected_by_foo方法，必须在include  Bar之前先要解决依赖关系，即 include Foo</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面这个例子对于大多数的使用者来说，就会很麻烦，因为我在include某个模块的时候必须解决他们的依赖关系，要知道我include的模块依赖哪些其他模块，这个对使用者来说有点困难。为了解决这个依赖的问题，貌似我们可以这样做，即将依赖关系放到module内去解决,如下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">module</span> <span class="nn">Foo</span>
</span><span class='line'>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>     <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>       <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">method_injected_by_foo</span>
</span><span class='line'>         <span class="c1">#...对宿主做某些操作，例如增強功能等等</span>
</span><span class='line'>       <span class="k">end</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="k">module</span> <span class="nn">Bar</span>
</span><span class='line'>   <span class="kp">include</span> <span class="no">Foo</span> <span class="c1">#在这里解决依赖问题</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>     <span class="n">base</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:do_host_something</span><span class="p">)</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="k">class</span> <span class="nc">Host</span>
</span><span class='line'>   <span class="kp">include</span> <span class="no">Bar</span> <span class="c1"># 这里只需要include一个Bar，而不用关心依赖问题</span>
</span><span class='line'> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上代码看似可以执行，但是问题是，在Foo被 Bar include的时候，对于Foo来说，此时的base为Bar，而不是 class Host，所以我们没法在Host include的时候，拿到Host中的do_host_something方法，因为它根本就不在Host中</p>

<p>3、为了解决以上讨论的两个问题，ActiveSupport::Concern出现了，对于上面的问题，你只要这样操作就可以了:</p>

<p>对于第一个问题，你可以这样解决:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;active_support/concern&#39;</span>
</span><span class='line'><span class="k">module</span> <span class="nn">M</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">scope</span> <span class="ss">:disabled</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">disabled</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>    <span class="c1">#...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>对于第二个问题，你可以这样解决:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;active_support/concern&#39;</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Foo</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>  <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">method_injected_by_foo</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Bar</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Foo</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">method_injected_by_foo</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Host</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Bar</span> <span class="c1"># 只include Bar就可以了，其他的我们不用关心</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>4、接下来，我们看看 active_support/concern 的源码是怎样来实现这些逻辑的</p>

<p>a、首先定义了一个异常类:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MultipleIncludedBlocks</span> <span class="o">&lt;</span> <span class="no">StandardError</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="k">super</span> <span class="s2">&quot;Cannot define multiple &#39;included&#39; blocks for a Concern&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>b、模块被extend的时候，为base添加一个类实例变量，并赋值为空数组，这个类实例变量是用来记录base模块(或者类)的所有依赖模块的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>  <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@_dependencies</span><span class="p">,</span> <span class="o">[]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>c、重写了ruby的 append_features 方法，这个append_features 是ruby Module中的方法，愿意是当一个module(a)被include 到另一个module(b)的时候，就会调用module  a 中的这个append_features方法，并且把module b 做为参数传给append_features方法，然后将module a中的常量，方法，变量添加到module b 中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="c1">#此时的base代表module b</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@_dependencies</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="ss">:@_dependencies</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>  <span class="c1">#此时的self是module a </span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">base</span> <span class="o">&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="vi">@_dependencies</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">dep</span><span class="o">|</span> <span class="n">base</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span> <span class="p">}</span>  <span class="c1"># module b 去 循环include  modulea 的依赖 module</span>
</span><span class='line'>    <span class="k">super</span>  <span class="c1"># 这个super 调用的是ruby原来的 append_features 方法</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="nb">const_get</span><span class="p">(</span><span class="ss">:ClassMethods</span><span class="p">)</span> <span class="k">if</span> <span class="nb">const_defined?</span><span class="p">(</span><span class="ss">:ClassMethods</span><span class="p">)</span> <span class="c1">#module b 去extend  module a 中定一的 ClassMethods 模块</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@_included_block</span><span class="p">)</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@_included_block</span><span class="p">)</span>  <span class="c1"># 为module b 动态添加一些内容(block中的内容)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>来看一下这个方法的具体逻辑，首先判断 module b 中是否已经有了类实例变量@<em>dependencies，如果有的话，那么将被include的module a 追加到这个变量中，如果一个module 中设置了 @</em>dependencies 这个变量 那么说明 该module 肯定extend 了active_support/concern，如果一个module中没有设置这个变量，可以肯定，该module 没有 extend  active_support/concern ，则该module是最后应用的那个module 。</p>

<p>d、重新定义included 方法，included方法是ruby module中的方法，当一个module a 被另一个module b include的时候，module a 的included 方法就会执行，并把module 作为一个参数 base 传递给该方法，我们可以在这里对base做一些inject，这里对included方法进行了重写。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">included</span><span class="p">(</span><span class="n">base</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>    <span class="k">raise</span> <span class="no">MultipleIncludedBlocks</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@_included_block</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@_included_block</span> <span class="o">=</span> <span class="n">block</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="k">super</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>当module a 被module include 后，如果这个方法传递了一个base，那么就直接使用ruby module中的included方法，如果我们在include的时候，传递的是一个block，那么就将该block 转化为proc对象，并赋值给 @_included_block 变量，这个变量会在 上边的 append_features方法中使用，这个block一般是用来动态给base 添加一些方法活属性用。例如:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;active_support/concern&#39;</span>
</span><span class='line'><span class="k">module</span> <span class="nn">M</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">included</span> <span class="k">do</span>  <span class="c1">#这里调用included方法，我们只传递了一个block，并且这个block中用来声明一些方法，将来这些方法会成为base的类方法</span>
</span><span class='line'>    <span class="n">scope</span> <span class="ss">:disabled</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">disabled</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>    <span class="c1">#...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
</feed>
